name: CI/CD - Core Checks

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  FORCE_COLOR: 1
  PYTHONIOENCODING: utf-8

jobs:
  test:
    name: Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-test.txt

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Run tests
        run: |
          pytest tests/ -v \
            --cov=modules/ \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=70

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail-ci-if-error: false

      - name: Quality check
        run: |
          pip install pre-commit
          pre-commit run --all-files

      - name: Type check
        run: |
          pip install mypy
          mypy modules/ --strict

  security:
    name: Security scan
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Security tools
        run: |
          pip install bandit safety
          bandit -r modules/ -ll --exclude tests/
          safety check --full-report

  summary:
    name: Final summary
    runs-on: ubuntu-latest
    needs: [test, security]
    if: always()
    steps:
      - name: Create report
        run: |
          TEST_STATUS="${{ needs.test.result }}"
          SEC_STATUS="${{ needs.security.result }}"
          OVERALL="success"

          if [ "$TEST_STATUS" != "success" ] || \
             [ "$SEC_STATUS" != "success" ]; then
            OVERALL="failure"
          fi

          {
            echo "# üéØ CI/CD Results"
            echo ""
            echo "| Stage | Status |"
            echo "|-------|--------|"
            echo "| Tests | $TEST_STATUS |"
            echo "| Security | $SEC_STATUS |"
            echo "| Overall | $OVERALL |"
            echo ""
            if [ "$OVERALL" = "success" ]; then
              echo "‚úÖ All checks passed!"
            else
              echo "‚ö†Ô∏è  Fix the failed stages above."
            fi
          } >> $GITHUB_STEP_SUMMARY

      - name: Success notice
        if: needs.test.result == 'success' && needs.security.result == 'success'
        run: |
          echo "üöÄ Pipeline passed! Ready to deploy."
          echo "::notice::CI/CD Succeeded!"

      - name: Failure notice
        if: failure()
        run: |
          echo "‚ùå Pipeline failed. Check logs."
          echo "::error::CI/CD Failed!"
